<!DOCTYPE html PUBLIC '-//W3C//DTD HTML 4.01 Transitional//EN' 'http://www.w3.org/TR/html4/loose.dtd'>
<html>
<head>
	<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
	<script type='text/x-handlebars' id="application">
        <header>
            <img src="../html/images/scholagest-logo1-2-small.png" class="app-logo" />
        </header>
        
        <div>
            {{outlet}}
            {{outlet modal}}
        </div>
        
        <footer>
            0.12.0-SNAPSHOT
        </footer>
	</script>
<!-- 	 {{action "close"}} -->
	<script type="text/x-handlebars" id="components/modal-dialog">
	    <div class="overlay">
	        <div class="modal" {{action bubbles=false}}>
	            {{yield}}
	        </div>
	    </div>
	</script>
	<script type="text/x-handlebars" id="login">
	    <table>
            <tr>
                <td>Nom d'utilisateur</td>
                <td>{{input value=username}}</td>
            </tr>
            <tr>
                <td>Mot de passe</td>
                <td>{{input type="password" value=password}}</td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <button type="submit" {{action login}} {{bindAttr disabled="isProcessing"}}>Log in!</button>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    {{#if loginFailed}}
                        <div style="color: red">
                            Nom d'utilisateur ou mot passe invalide
                        </div>
                    {{/if}}
                </td>
            </tr>
        </table>
	</script>
    <script type="text/x-handlebars" id="logout">
        <h1>Vous avez été déconnecté</h1>
        {{#link-to "login"}}Retour au login{{/link-to}}
    </script>
    <script type="text/x-handlebars" id="sessionexpired">
        <h1>La session n'est plus valide</h1>
        {{#link-to "login"}}Retour au login{{/link-to}}
    </script>
	<script type="text/x-handlebars" id="base">
        <div>
            <span>{{#link-to "students"}}Etudiants{{/link-to}}</span>
            <span>{{#link-to "teachers"}}Professeurs{{/link-to}}</span>
            <span>{{#link-to "years"}}Volées{{/link-to}}</span>
            <span>{{#link-to "periods"}}Périodes{{/link-to}}</span>
            <span>{{#link-to "logout"}}Logout{{/link-to}}</span>
        </div>
        
        <div>
            {{outlet}}
        </div>
	</script>
	<script type='text/x-handlebars' id="students">
        <ul>
            {{#each student in controller}}
                <li>
                    {{#link-to "student" student}}
                        {{student.fullName}}
                    {{/link-to}}
                </li>
            {{else}}
                <li>Pas d'élèves...</li>
            {{/each}}
        </ul>

        {{outlet}}
	</script>
    <script type='text/x-handlebars' id="student">
        <h2>{{firstName}} {{lastName}}</h2>
        
        {{partial "studentPersonal"}}
        <button {{action savePersonal}}>Enregistrer</button>
        
        {{partial "studentMedical"}}
        <button {{action saveMedical}}>Enregistrer</button>
    </script>
    <script type='text/x-handlebars' id="studentPersonal">
        <h3>Informations personnelles</h3>
        
        <table>
            <tr>
                <td>Prénom</td><td>{{input value=firstName}}</td>
            </tr>
            <tr>
                <td>Nom</td><td>{{input value=lastName}}</td>
            </tr>
            <tr>
                <td>Rue</td><td>{{input value=personal.street}}</td>
            </tr>
            <tr>
                <td>Code postal</td><td>{{input value=personal.postcode}}</td>
            </tr>
            <tr>
                <td>Ville</td><td>{{input value=personal.city}}</td>
            </tr>
            <tr>
                <td>Religion</td><td>{{input value=personal.religion}}</td>
            </tr>
        </table>
    </script>
    <script type='text/x-handlebars' id="studentMedical">
        <h3>Informations personnelles</h3>
        
        <table>
            <tr>
                <td>Docteur</td><td>{{input value=medical.doctor}}</td>
            </tr>
        </table>
    </script>
	
	<script type='text/x-handlebars' id="teachers">
        <h1>Professeurs</h1>
        <div>
            <button {{action 'openModal' 'newTeacher'}}>Nouveau professeur</button>
        </div>
        <ul>
            {{#each teacher in controller}}
                <li>
                    {{#link-to "teacher" teacher}}
                        {{teacher.fullName}}
                    {{/link-to}}
                </li>
            {{else}}
                <li>Pas de professeur...</li>
            {{/each}}
        </ul>

        {{outlet}}
	</script>
    <script type='text/x-handlebars' id="teacher">
        <h2>{{fullName}}</h2>
        
        <table>
            <tr>
                <td>Prénom</td><td>{{input value=firstName}}</td>
            </tr>
            <tr>
                <td>Nom</td><td>{{input value=lastName}}</td>
            </tr>
            <tr>
                <td>Email</td><td>{{input value=detail.email}}</td>
            </tr>
            <tr>
                <td>Adresse</td><td>{{input value=detail.address}}</td>
            </tr>
            <tr>
                <td>Téléphone</td><td>{{input value=detail.phone}}</td>
            </tr>
        </table>

        <button {{action save}}>Enregistrer</button>
    </script>
    <script type='text/x-handlebars' id="newTeacher">
        {{#modal-dialog action="close"}}
	        <h2>Nouveau professeur</h2>
	        
	        <table>
	            <tr>
	                <td>Prénom</td><td>{{input value=firstName}}</td>
	            </tr>
	            <tr>
	                <td>Nom</td><td>{{input value=lastName}}</td>
	            </tr>
	            <tr>
	                <td>Email</td><td>{{input value=email}}</td>
	            </tr>
	            <tr>
	                <td>Adresse</td><td>{{input value=address}}</td>
	            </tr>
	            <tr>
	                <td>Téléphone</td><td>{{input value=phone}}</td>
	            </tr>
	        </table>
	
	        <button {{action create}} >Enregistrer</button>
	    {{/modal-dialog}}
    </script>
    
    <script type='text/x-handlebars' id="years">
        <h2>Volées</h2>
        
        {{#if isStarting}}
            <span>
                {{input value=newYearName}}
                <button {{action createYear}}>Démarrer!</button>
            </span>
        {{else}}
            <button {{action startYear}} {{bind-attr disabled=isStarted}}>Démarrer une année</button>
        {{/if}}
        <button {{action stopYear}} {{bind-attr disabled=isStopped}}>Arrêter une année</button>
        {{#if isRenaming}}
            <span>
               {{input value=runningYear.name}}
                <button {{action renameYear}}>Renommer!</button>
            </span>
        {{else}}
            <button {{action startRenaming}} {{bind-attr disabled=isStopped}}>Renommer une année</button>
        {{/if}}
        
        <button {{action createClass}} {{bind-attr disabled=isStopped}}>Créer une classe</button>
        <ul>
            {{#each year in controller}}
                <li>{{year.name}}</li>
                {{#each class in year.classes}}
                    <li>
                        {{#link-to "class" class}}
                            {{class.name}}
                        {{/link-to}}
                    </li>
                    {{! <li>{{class.name</li> }}
                {{/each}}
            {{else}}
                <li>Pas de volée...</li>
            {{/each}}
        </ul>

        {{outlet}}
    </script>
    <script type='text/x-handlebars' id="class">
        <h1>Classe {{name}}</h1>

        <table>
            <tr>
                <td>Nom</td><td>{{input value=name}}</td>
            </tr>
            <tr>
                <td>Elèves</td>
                <td>
                    <ul>
                        {{#each student in students}}
                            <li>{{student.fullName}}</li>
                        {{else}}
                            <li>Pas d'élève</li>
                        {{/each}}
                    </ul>
                </td>
            </tr>
            <tr>
                <td>Professeurs</td>
                <td>
                    <ul>
                        {{#each teacher in teachers}}
                            <li>{{teacher.fullName}}</li>
                        {{else}}
                            <li>Pas de professeur</li>
                        {{/each}}
                    </ul>
                </td>
            </tr>
        </table>
    </script>
    
    <script type='text/x-handlebars' id="periods">
        <h2>Périodes</h2>
        
        <ul>
            {{#each period in periods}}
                <li>
                    {{#link-to "period" period}}
                        {{period.name}}
                    {{/link-to}}
                </li>
            {{else}}
                <li>Pas de période...</li>
            {{/each}}
        </ul>

        {{outlet}}
    </script>
    <script type='text/x-handlebars' id="period">
        <h2>{{name}}</h2>
        
        <ul>
            {{#each branch in branches}}
                <li>
                    {{#link-to "branch" branch}}
                        {{branch.name}}
                    {{/link-to}}
                </li>
            {{else}}
                <li>Pas de branche...</li>
            {{/each}}
        </ul>

        {{outlet}}
    </script>
    <script type='text/x-handlebars' id="branch">
        <h2>{{name}}</h2>
        
        <table>
            <tr>
                <td></td>
                {{#each exams}}
                    <td>{{partial "exam"}}</td>
                {{/each}}
                <td>Moyenne</td>
            </tr>
            
            {{#each studentResult in studentResults}}
                <tr>
                    <td>{{studentResult.student.fullName}}</td>
                    {{#each result in studentResult.results}}
                        <td>{{input value=result.grade}}</td>
                    {{/each}}
                    
                    {{#if branch.numerical}}
                        <td>{{studentResult.mean.computedMean}}</td>
                    {{else}}
                        <td>{{input value=studentResult.mean.grade}}</td>
                    {{/if}}
                </tr>
            {{/each}}
        </table>

        <button {{action save}} >Enregistrer</button>
    </script>
    <script type='text/x-handlebars' id="exam">
        {{#if edit}}
            {{input value=name}} (coeff: {{input value=coeff}}) <button {{action "saveExam"}}>Enregistrer</button>
        {{else}}
            {{name}} (coeff: {{coeff}}) <button {{action "editExam" target="controller"}}>Editer</button>
        {{/if}}
    </script>
	<!-- 
        {{! {{#each attribute in metadata }}
        {{!     {{attribute.name }}
        {{!     {{! {{input value=attribute.value }}
        {{!     {{view Scholagest.AutoTextField name=attribute.name }}
        {{!     <br /> }}
        {{! {{/each }}
        
        {{! <button {{action "delete"}}>Delete</button> }} -->
    <script src='../jquery-1.10.2.js'></script>
    <script src='../jquery.json-2.4.js'></script>
	<script src='../handlebars-1.1.2.js'></script>
	<script src='../ember.js'></script>
	<script src='../ember-data.js'></script>
    <script type="text/javascript">
        Scholagest = Ember.Application.create({
		    LOG_TRANSITIONS: true
		});
		Scholagest.ApplicationAdapter = DS.RESTAdapter;
		
		DS.RESTAdapter.reopen({
		    host: 'http://localhost:8080',
		    namespace: 'scholagest-app/services'
		});
		
		DS.RESTSerializer.reopen({
			serializeHasMany: function(record, json, relationship) {
				var key = relationship.key;
				var relationshipType = DS.RelationshipChange.determineRelationshipType(record.constructor, relationship);
				
				if (relationshipType === 'manyToNone' || relationshipType === 'manyToMany' || relationshipType === 'manyToOne') {
				    json[key] = Ember.get(record, key).mapBy('id');
				}
			}
		});
		
		Scholagest.Router.map(function() {
			this.resource('login', function() {});
			this.resource('logout', function() {});
			this.resource('sessionexpired', function() {});
			this.resource('base', function() {
				this.resource('students', function() {
				    this.resource('student', { path: '/:student_id' }, function() {});
				});
				this.resource('teachers', function() {
				    this.resource('teacher', { path: '/:teacher_id' }, function() {});
				});
				this.resource('years', function() {
				    this.resource('class', { path: '/:class_id' }, function() {});
				});
				this.resource('periods', function() {
				    this.resource('period', { path: '/:period_id' }, function() {
				        this.resource('branch', { path: '/:branch_id' }, function() {});
				    });
				});
				this.resource('newTeacher', function() {});
			});
		});
    </script>
    <script src='js/index.js'></script>
    <script src='js/base.js'></script>
    <script src='js/model.js'></script>
    <script src='js/login.js'></script>
    <script src='js/model.js'></script>
    <script src='js/year.js'></script>
    <script src='js/class.js'></script>
    <script src='js/student.js'></script>
    <script src='js/teacher.js'></script>
    <script src='js/branch.js'></script>
	
	<title>Scholagest</title>
</head>
<body>
</body>
</html>